## DNS域名解析协议

DNS（DomainNameSystem）系统用于命名阻止到域层次结构中的计算机和网络服务。

使用 IP 地址而非使用域名进行通信的原因：

* IP 地址是固定长度，IPv4 是32位，IPv6 是128位，而域名是变长的，不便于计算机处理
* IP 地址对于用户来说不方便记忆，但域名便于用户使用

总结来说就是 IP 面向主机，域名面向用户。

⛳️ ***hosts***

域名和 IP 的对应关系保存在一个叫 hosts 文件中。

### DNS系统

1. 一个组织的系统管理机构，维护系统内的每个主机的IP和主机名的对应关系
2. 如果新计算机接入网络，将这个信息注册到数据库中
3. 用户输入域名的时候，会自动查询DNS服务器，由DNS服务器检索数据库，得到对应的IP地址 
   我们可以通过命令查看自己的 `hosts` 文件

在域名解析的过程中仍然会优先查找 hosts 文件的内容。

### DNS域名结构

#### 域名的层次结构

**域名系统必须要保持唯一性。**

1. 每个域名都是一个标号序列，用字母（大小写等价）、数字（0-9）和连接符（-）组成
2. 标号序列总长度不能超过255个字符，它由点号分割成一个个的标号
3. 每个标号应该在63个字符之内，每个标号都可以堪称一个层次的域名
4. 级别最低的域名写在左边，级别最高的域名写在右边

域名服务是基于 UDP 实现的，服务器的端口号为53。

🌰 例如：

`www.google.com`

* `com` 一级域名，表示这是个企业域名
* `google` 二级域名，表示公司名
* `www` 万维网

#### 域名的分级

域名可以划分为各个子域，子域还可以继续划分为子域的子域，这样就形成了顶级域、二级域、三级域等。

| 顶级域名     | 标识                                                         |
| ------------ | ------------------------------------------------------------ |
| 国家顶级域名 | 中国 `cn`；美国 `us`；英国 `uk`                              |
| 通用顶级域名 | 公司企业 `com`；教育机构 `edu`；政府部门 `gov`；国际组织 `int`；军事部门 `mil`；网络 `net`；非盈利组织 `org` |
| 反向域名     | arpa 用于 PTR 查询（IP 地址转换为域名）                      |

### 域名服务器

域名是分层结构，域名服务器也是对应的层级结构。

域名服务器 => 装有域名系统的主机

由高到低进行层次划分。

| 分类           | 作用                                                         |
| -------------- | ------------------------------------------------------------ |
| 根域名服务器   | 最高层次的域名服务器，本地域名服务器解析不了的域名就会向其求助 |
| 顶级域名服务器 | 负责管理在该顶级域名服务器下注册的耳机线域名                 |
| 权限域名服务器 | 负责一个区的域名解析工作                                     |
| 本地域名服务器 | 当一个主机发出 DNS 查询请求时，这个查询请求首先发给本地域名服务器 |

⚠️ 一个域名服务器所负责的范围，或者说有管理权限的范围，就称为区。

> 1. 每个层的域名上都有自己的域名服务器，最顶层的是根域名服务器
> 2. 每一级域名服务器都知道下级域名服务器的IP地址
> 3. 为了容灾, 每一级至少设置两个或以上的域名服务器

### 域名解析过程

DNS 是一种实用 UDP 协议进行域名查询的协议，其最主要的目标就是将域名转换为 IP 地址。

以查询 `www.meituan.com` 对应的 IP 地址为例，操作系统首先会在本地尝试解析，比如使用众所周知的 `hosts` 文件，同时如果有解析缓存的话，操作系统也会去查询。如果是在浏览器中进行查询，浏览器自己有时也会有解析缓存。

* 用户设备
  * 浏览器可能会缓存域名解析
  * 用户系统中可以有自己的域名映射表
* 公共域名服务器
  * 通常由 ISP 提供
  * 缓存上一级域名服务器的结果

在查询没有结果时，设备最终会开始向域名服务器发起查询请求。公共域名服务器一般就是用户的 ISP 提供的。这种公共域名服务器通常会缓存查询结果，因此如果缓存命中，查询就可以到此结束。当然缓存本身是有时效的，这个时效就被称为 TTL。对于超过时效的查询结果，域名服务器有义务重新发起查询请求。但查询本身是非常消耗流量的事情，因此也有一些公共服务器不严格遵守 TTL，超时缓存。

未命名缓存的查询，公共服务器会向顶级域名服务器进行查询。以上述例子来说，因为公共域名服务器不知道 `meituan.com` 的解析权归谁，因此它会向顶级域名服务器——`com` 域名服务器发起请求，寻找 `meituan.com` 对应的域名服务器。顶级域名服务器一般是由域名经营机构来维护的，有些甚至归属国家机关管理，例如国别域名。理论上来说，在顶级域名服务器之上还有一个根域名服务器，不过在平时很难意识到它的存在。

* 公共域名服务器
  * DNS 级联的特性决定了中途可以有更多域名服务器
* 顶级域名服务器
  * 由顶级域名经营机构维护
  * 可细分为与国家、通用

在查找到 `meituan.com` 的域名服务器之后，就可以向域名服务器查询 `www.meituan.com` 的 IP 了。这个过程是由上到下指定下来的，所以这种域名服务器可以被称为权威域名服务器。对于开发者来说，我们自己平时在域名服务器那里购买到域名之后，录入自己域名对应的 IP，其实就是在向权威域名服务器录入信息。一些大型企业会自己维护权威域名服务器，这样既可以抵御一些针对性的攻击，同时也可以更好地优化解析的速度。

* 公共域名服务器
* 权威域名服务器
  * 通常由专业的域名服务机构提供
  * 购买域名时一般会提供

**解析步骤：**

1. 主机先向本地域名服务器进行递归查询
2. 本地域名服务器采用迭代查询，向一个根域名服务器进行查询 
3. 根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器的IP地址 
4. 本地域名服务器向顶级域名服务器进行查询 
5. 顶级域名服务器告诉本地域名服务器，下一步查询权限服务器的IP地址 
6. 本地域名服务器向权限服务器进行查询 
7. 权限服务器告诉本地域名服务器所查询的主机的IP地址 
8. 本地域名服务器最后把查询结果告诉主机 



---

**参考资料：**

* [DNS（域名解析协议）详解](https://blog.csdn.net/baidu_37964071/article/details/80500825)
* [从输入 URL 到页面加载完成的过程中都发生了什么](https://www.tuicool.com/articles/V7JN32Z)