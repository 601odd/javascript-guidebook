<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/javascript-guidebook/umi.b538b811.css" />
    <script>
      window.routerBase = "/javascript-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.7
    </script>
    <title>&#x6D41;&#x91CF;&#x52AB;&#x6301;</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//">JavaScript Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/javascript-guidebook//basic-concept">基本语法</a><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a><a href="/javascript-guidebook//core-modules">核心模块</a><a href="/javascript-guidebook//object-oriented-programming">OOP</a><a href="/javascript-guidebook//browser-object-model">BOM</a><a href="/javascript-guidebook//document-object-model">DOM</a><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks">计算机网络</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//"></a><h1>JavaScript Guidebook</h1><p>JavaScript 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/javascript-guidebook//basic-concept">基本语法</a></li><li><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a></li><li><a href="/javascript-guidebook//core-modules">核心模块</a></li><li><a href="/javascript-guidebook//object-oriented-programming">OOP</a></li><li><a href="/javascript-guidebook//browser-object-model">BOM</a></li><li><a href="/javascript-guidebook//document-object-model">DOM</a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture">计算机网络体系</a><ul><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/computer-networks"><span>计算机网络体系</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/transport-layer-protocol"><span>传输层协议</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/network-layer-protocol"><span>网络层协议</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/dns"><span>DNS 域名解析协议</span></a></li><li><a href="/javascript-guidebook//computer-networks/computer-network-architecture/cdn"><span>CDN 内容分发网络</span></a></li></ul></li><li><a href="/javascript-guidebook//computer-networks/http">HTTP</a><ul><li><a href="/javascript-guidebook//computer-networks/http/http"><span>HTTP</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/https"><span>HTTPS</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/headers"><span>HTTP 首部字段</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/request-methods"><span>HTTP 请求方法</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/response-status-codes"><span>HTTP 状态码</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/access-control"><span>HTTP 跨域资源共享</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/authentication"><span>HTTP 身份校验</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http2"><span>HTTP2</span></a></li><li><a href="/javascript-guidebook//computer-networks/http/http3"><span>HTTP3</span></a></li></ul></li><li><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks/frontend-security">Web 安全</a><ul><li><a href="/javascript-guidebook//computer-networks/frontend-security/xss"><span>XSS 攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/frontend-security/csrf"><span>CSRF 攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/frontend-security/ddos"><span>DDoS 攻击</span></a></li><li><a href="/javascript-guidebook//computer-networks/frontend-security/sql-injection"><span>SQL 注入攻击</span></a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//computer-networks/frontend-security/hijacking"><span>流量劫持</span></a></li><li><a href="/javascript-guidebook//computer-networks/frontend-security/same-origin-policy"><span>同源策略</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="DNS 劫持" data-depth="2" class=""><a href="/javascript-guidebook//computer-networks/frontend-security/hijacking#dns-劫持"><span>DNS 劫持</span></a></li><li title="攻击原理" data-depth="3" class=""><a href="/javascript-guidebook//computer-networks/frontend-security/hijacking#攻击原理"><span>攻击原理</span></a></li><li title="防御策略" data-depth="3" class=""><a href="/javascript-guidebook//computer-networks/frontend-security/hijacking#防御策略"><span>防御策略</span></a></li><li title="HTTP 劫持" data-depth="2" class=""><a href="/javascript-guidebook//computer-networks/frontend-security/hijacking#http-劫持"><span>HTTP 劫持</span></a></li><li title="防御策略" data-depth="3" class=""><a href="/javascript-guidebook//computer-networks/frontend-security/hijacking#防御策略-1"><span>防御策略</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="流量劫持"><a aria-hidden="true" href="#流量劫持"><span class="icon icon-link"></span></a>流量劫持</h1><p><strong>流量劫持的方式主要分为两种，域名劫持（DNS 劫持）和数据劫持（HTTP 劫持）。</strong></p><p>我们国内用户，一般是在家用路由器后面，要访问一个网站的话，会有三个步骤：</p><ol><li>首先访问 DNS 服务器，将域名转换为 IP 地址。</li><li>访问这个 IP 地址，这样用户就访问了目标网站。</li><li>如果是一个建设良好的网站，一般会把静态资源放在 CDN 上。</li></ol><p>流量劫持就是在这些环节当中，对数据进行偷窃、篡改，甚至转发流量进行攻击的这样一类行为。从危害上来说，互联网上最可怕的攻击也莫过于此了。那互联网发展这么多年了，为什么流量劫持还能够横行呢？流量劫持能够发生，无非是两个原因：</p><ol><li>网络链路本身不安全。网络链路牵扯到具体的网络协议，这些协议当中，有些从设计上就没有考虑安全问题，贻害至今；另有一些，在当时可能是安全的，但正所谓“没有绝对的安全”，随着计算力和攻击手段的发展，当时安全的协议如今可能已经变得不再安全。</li><li>干扰安全链路，迫使链路降级到不安全的方案上。这一点可以归结到前面，但单独拿出来说，是因为很多攻击手段会利用这一点去做，导致我们的安全方案根本没有使用起来。</li></ol><p>下面我们会详细介绍这些环节当中的流量劫持是怎么发生的，以及如何防御。</p><h2 id="dns-劫持"><a aria-hidden="true" href="#dns-劫持"><span class="icon icon-link"></span></a>DNS 劫持</h2><p><strong>域名劫持（DNS 劫持）</strong>是针对传统 DNS 解析的常见劫持方式。用户在浏览器输入网址，即发出一个 HTTP 请求，首先需要进行域名解析，得到业务服务器的 IP 地址。使用传统 DNS 解析时，会通过当地网络运营商提供的 Local DNS 解析得到结果。域名劫持，即是在请求 Local DNS 解析域名时出现问题，目标域名被恶意地解析到其他 IP 地址，造成用户无法正常使用服务。<a href="/javascript-guidebook//computer-networks/dns#%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E8%BF%87%E7%A8%8B">🌐关于域名解析过程详解</a></p><h3 id="攻击原理"><a aria-hidden="true" href="#攻击原理"><span class="icon icon-link"></span></a>攻击原理</h3><p>那么如何才能够污染 DNS 以达成流量劫持的目的呢？粗略来说，一共有三种途径：</p><ol><li><strong>在用户设备上动手</strong>。这个主要是通过一些恶意软件实现的，比如早期一些流氓软件会在用户本机篡改<code>hosts</code>文件，影响用户的搜索引擎工作。</li><li><strong>污染中间链路设备</strong>。由于 DNS 查询是基于 UDP 协议明文发送的，因此在任意中间设备上——比如路由器——进行中间人攻击，修改 UDP 包的内容，就可以影响 DNS 的结果了。</li><li><strong>入侵 DNS 服务器</strong>。这是一种成本比较高的方案，看起来似乎很困难，但 DNS 是一种相对古老的技术，其服务软件的实现可能已经年久失修，别有用心的攻击者可以寻找一些缺乏维护的 DNS 服务器，施行攻击。另外，有时 DNS 服务器上不止运行 DNS 软件，还会有一些其他的软件也在运行，比如同时也启动了 HTTP 服务等，这时攻击者也可以通过这些软件的漏洞来控制服务器，进而影响 DNS 的解析。由于 DNS 的缓存和上下传递关系，一旦有 DNS 服务器被影响，就会一次影响很多用户的访问，因此非常危险。</li></ol><p>这三种途径当中，第一种和第三种的实施成本都比较高，但污染链路设备，在 Wi-Fi 普及而安全意识尚未普及的今天，是最容易得手的一种途径。</p><h3 id="防御策略"><a aria-hidden="true" href="#防御策略"><span class="icon icon-link"></span></a>防御策略</h3><p>目前针对 DNS 投毒，对抗中间人攻击的研究比较多。DNS 协议本身的安全性较差，而改造 DNS 协议又比较困难，因此现在主要的防御手段，集中在替换 UDP 协议上。</p><ul><li>TLS（Cloudflare）</li><li>HTTP（腾讯云、阿里云）</li><li>HTTPS（Cloudflare、Google）</li></ul><p>目前，三种常见的替代方式比较流行：</p><ol><li>DNS over TLS。这种协议是在 TLS 协议之上传输 DNS 内容，有点类似 HTTPS 和 TLS 关系。</li><li>DNS over HTTP。用 HTTP 协议来传输 DNS ，也是可以的。国内厂商当中对这种方案的支持较多。最简单的实现是使用一个 固定的 IP 地址作为域名服务器，每次不发生 UDP ，而是向这台服务器发送 HTTP 请求来获取解析结果。但通常很难签发相应的证书给固定 IP，因此也有些厂商自己对 HTTP 报文进行加密，从而防止这些解析结果再被中间人篡改。</li><li>DNS over HTTPS。和第二点比较类似，区别是使用了 HTTPS 协议。根据我的观察，采用这种方案的 Google 和 Cloudflare 都使用的是域名而非固定 IP ，因此还是要先解析一次域名服务器自身的域名才可以进行真正的查询。这可能会导致再次被中间人扰乱，从而迫使用户降级到普通的 UDP 方式上。</li></ol><p>比较遗憾的是，由于浏览器没有暴露 DNS 相关的接口，这三种较为安全的 DNS 查询方式，都无法在前端当中得以使用。而 iOS 和 Android 开发者有机会使用其中的技术进行加强，但需要单独编写一些代码。</p><h2 id="http-劫持"><a aria-hidden="true" href="#http-劫持"><span class="icon icon-link"></span></a>HTTP 劫持</h2><p>HTTP 协议属于明文协议，中间链路上的任意设备，都可以篡改内容，导致流量劫持。</p><h3 id="防御策略-1"><a aria-hidden="true" href="#防御策略-1"><span class="icon icon-link"></span></a>防御策略</h3><h4 id="content-security-policy"><a aria-hidden="true" href="#content-security-policy"><span class="icon icon-link"></span></a>Content Security Policy</h4><p>CSP 原本是为了和 XSS 对抗而产生的一种技术方案，其原理是在 HTML 加载的时候，指定每种资源的 URL 白名单规则，防止 XSS 的运行和数据外送。但如果巧妙利用规则，也可以让所有的资源强制走 HTTPS ，这样就可以降低流量劫持的可能性。</p><p>具体的 CSP 规则比较复杂，大家可以在 <a href="https://link.juejin.im/?target=https%3A%2F%2Flink.zhihu.com%2F%3Ftarget%3Dhttps%253A%2F%2Fcontent-security-policy.com%2F" target="_blank" rel="noopener noreferrer">CSP 专属网站<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>上自己查看。</p><p>CSP 用来防劫持的缺点也比较明显：</p><ul><li>CSP 可以用在 HTTP 页面，这也是我们想在 HTTP 页面用它做防御的一个原因。但中间人攻击可以在链路上直接移除 CSP 的相关标记，导致 CSP 全部失效。</li><li>CSP 规则设置比较复杂。不然也不会有一个网站专门用来查询和生成规则了。设置不当很容易玩脱，会直接导致你的资源不可用。</li><li>影响动态创建脚本。CSP 存在的一部分意义就是阻止动态创建脚本这种行为，这是防御 XSS 的一种办法。但同时市面上很多技术方案也是基于这种方式做的，比如一些统计 SDK 之类的，甚至有些开发人员的开发模式即是如此。</li></ul><h4 id="subresource-integrity"><a aria-hidden="true" href="#subresource-integrity"><span class="icon icon-link"></span></a>Subresource Integrity</h4><p>SRI 是专门用来校验资源的一种方案，它读取资源标签中的 <code>integrity</code> 属性，将其中的信息摘要值，和资源实际的信息摘要值进行对比，如果发现无法匹配，那么浏览器就会拒绝执行资源。对于 <code>&lt;script&gt;</code> 标签来说，就是拒绝执行其中的代码，对于 CSS 来说则是不加载其中的样式。</p><p>理想上来说，这样的方案可以杜绝中间人对资源的篡改。不过和 CSP 一样，它也有自己的局限性：</p><ul><li>和 CSP 一样，当我们用在 HTTP 页面中时，中间人可以直接移除 SRI 的相关属性，这样就完全失效了。</li><li>动态创建的脚本时，除非单独在前端计算信息摘要，否则无法使用 SRI 。</li><li>如果中途因为某种原因修改了脚本内容而忘记了更新摘要值，那么会直接影响可用性。有些自作聪明的代理或资源托管服务器，会对 JavaScript 进行压缩或者混淆，而这个过程对开发者透明，这样也会导致可用性受到影响。</li><li>兼容性比较有限。 iOS Safari 的支持至少需要 iOS 11，在目前看来不是很理想。</li></ul><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://juejin.im/post/5c355a816fb9a049a42f3ac8" target="_blank" rel="noopener noreferrer">使用 SRI 解决 CDN 劫持<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/entry/5bcec8e2518825102423e391" target="_blank" rel="noopener noreferrer">浅谈流量劫持与防治<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/entry/5a559dd36fb9a01c9e45d896" target="_blank" rel="noopener noreferrer">常见 Web 安全攻防总结<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook/edit/master/docs/computer-networks/frontend-security/hijacking.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">7/2/2020, 4:20:09 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/javascript-guidebook/umi.ea2532d0.js"></script>
    <script src="/javascript-guidebook/docs__computer-networks__frontend-security__hijacking.md.e718c459.async.js"></script>
  </body>
</html>
