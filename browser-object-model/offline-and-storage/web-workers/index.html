<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/javascript-guidebook/umi.css" />
    <script>
      window.routerBase = "/javascript-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>Web Workers</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//">JavaScript Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/javascript-guidebook//basic-concept">基本语法</a><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a><a href="/javascript-guidebook//core-modules">核心模块</a><a href="/javascript-guidebook//object-oriented-programming">OOP</a><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model">BOM</a><a href="/javascript-guidebook//document-object-model">DOM</a><a href="/javascript-guidebook//computer-networks">计算机网络</a><a href="/javascript-guidebook//design-patterns">设计模式</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//"></a><h1>JavaScript Guidebook</h1><p>JavaScript 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/javascript-guidebook//basic-concept">基本语法</a></li><li><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a></li><li><a href="/javascript-guidebook//core-modules">核心模块</a></li><li><a href="/javascript-guidebook//object-oriented-programming">OOP</a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model">BOM</a></li><li><a href="/javascript-guidebook//document-object-model">DOM</a></li><li><a href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a href="/javascript-guidebook//design-patterns">设计模式</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/javascript-guidebook//browser-object-model">BOM 浏览器对象模型</a></li><li><a href="/javascript-guidebook//browser-object-model/window">全局对象</a><ul><li><a href="/javascript-guidebook//browser-object-model/window/window"><span>Window 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/location"><span>Location 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/history"><span>History 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/screen"><span>Screen 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/navigator"><span>Navigator 对象</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/web-event">全局 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/web-event/set-interval"><span>setInterval 间歇调用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/set-time-out"><span>setTimeout 超时调用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/alert"><span>alert</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/confirm"><span>confirm</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/prompt"><span>prompt</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/drag-and-drop-api"><span>拖放 API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/request-animation-frame"><span>动画 API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/window-position">视窗尺寸位置</a><ul><li><a href="/javascript-guidebook//browser-object-model/window-position/window-view-properties"><span>Window 对象视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/screen-view-properties"><span>Screen 对象视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/element-view-properties"><span>Element 文档元素视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/document-view-and-element-view"><span>文档视图和元素视图</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/mouse-position"><span>鼠标位置</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files">二进制数据和文件 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/local-files-application"><span>本地文件应用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/blob"><span>Blob API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file"><span>File API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-list"><span>FileList API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-reader"><span>FileReader API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-reader-sync"><span>FileReaderSync API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/url"><span>URL API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/form-data"><span>FormData API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/connectivity">数据通信 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/connectivity/post-message"><span>PostMessage</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/xmlhttprequest"><span>XHMLHttpRequest API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/featch"><span>Fetch API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/beacon"><span>Beacon API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/web-socket"><span>WebSocket</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/event-source"><span>EventSource</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events"><span>Server-sent Events</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/web-real-time-communication"><span>WebRTC</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/progress-event"><span>Progress Event</span></a></li></ul></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model/offline-and-storage">离线与存储 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/browser-cache"><span>浏览器缓存机制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/http-cache"><span>HTTP Cache</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/cookie"><span>Cookie</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-storage"><span>Web Storage</span></a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers"><span>Web Workers</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/service-worker"><span>Service Worker</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/indexed-db"><span>IndexedDB</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/performance">性能 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/performance/performance"><span>Performance API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/performance-resource-timing"><span>Performance Resource Timing API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/performance-navigation-timing"><span>Performance Navifation API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/perfromance-timeline"><span>性能时间线</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/multimedia">多媒体 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/multimedia/audio"><span>音频</span></a></li><li><a href="/javascript-guidebook//browser-object-model/multimedia/video"><span>视频</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/device">设备 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/device/geolocation"><span>地理定位</span></a></li><li><a href="/javascript-guidebook//browser-object-model/device/touch-event"><span>触控事件</span></a></li><li><a href="/javascript-guidebook//browser-object-model/device/camera"><span>摄像头访问</span></a></li><li><a href="/javascript-guidebook//browser-object-model/device/the-position-object"><span>Position 对象</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/integration">集成 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/integration/full-screen"><span>全屏 API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle">浏览器工作原理</a><ul><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/browser-architecture"><span>浏览器架构</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/workflow"><span>渲染进程的内部机制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/construction-of-the-object-model"><span>构建对象模型</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/script-loading-asynchronously"><span>脚本异步加载</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/construction-of-render-tree"><span>渲染树构建</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/layout"><span>布局</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/paint"><span>绘制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/composite"><span>合并</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/browser-event"><span>浏览器事件处理</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="基本用法" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#基本用法"><span>基本用法</span></a></li><li title="主线程" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#主线程"><span>主线程</span></a></li><li title="Worker 线程" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#worker-线程"><span>Worker 线程</span></a></li><li title="终止" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#终止"><span>终止</span></a></li><li title="加载脚本" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#加载脚本"><span>加载脚本</span></a></li><li title="错误处理" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#错误处理"><span>错误处理</span></a></li><li title="数据通信" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#数据通信"><span>数据通信</span></a></li><li title="同页面的 Web Worker" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#同页面的-web-worker"><span>同页面的 Web Worker</span></a></li><li title="应用场景" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#应用场景"><span>应用场景</span></a></li><li title="实例：Worker 线程完成轮询" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#实例：worker-线程完成轮询"><span>实例：Worker 线程完成轮询</span></a></li><li title="实例：Worker 新建 Worker" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#实例：worker-新建-worker"><span>实例：Worker 新建 Worker</span></a></li><li title="API" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#api"><span>API</span></a></li><li title="主线程" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#主线程-1"><span>主线程</span></a></li><li title="Worker 线程" data-depth="3" class=""><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers#worker-线程-1"><span>Worker 线程</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="web-workers"><a aria-hidden="true" href="#web-workers"><span class="icon icon-link"></span></a>Web Workers</h1><p>JavaScript 语言采用的是单线程模型，也就是说，所有任务只能在一个线程上完成，一次只能做一件事。前面的任务没做完，后面的任务只能等着。随着电脑计算能力的增强，尤其是多核 CPU 的出現，单线程带来很大的不变，无法充分发挥计算机的计算能力。</p><p>Web Worker 的作用，就是为 JavaScript 创造多线程环境，允许主线程创建 Worker 线程，将一些任务分配给后者运行。在主线程运行的同时，Worker 线程在后台运行，两者互不干扰。等到 Worker 线程完成计算任务，再把结果返回给主线程。这样的好处是，一些计算密集型或高延迟的任务，被 Worker 线程负担了，主线程（通常负责 UI 交互）就会很流畅，不会被阻塞或拖慢。</p><p>Worker 线程一旦创建成功，就会始终运行，不会被主线程上的活动（比如用户点击按钮、提交表单）打断。这样有利于随时响应主线程的通信。但是，这也造成了 Worker 比较耗费资源，不应该过度使用，而且一旦使用完毕，就应该关闭。</p><p>Worker 使用构造函数 <code>WebWorker</code> 运行一个命名的 JavaScript 文件，这个文件包含将在工作线程中运行的代码。Worker 运行在另一个全局上下文中，不同与当前的 <code>window</code>。因此，使用 <code>window</code> 快捷方式获取当前全局范围在一个 Worker 内将返回错误。</p><p>在 Worker 线程中你可以运行任何代码，不过有一些例外情况。比如：在 Worker 内，不能直接操作 DOM 节点，也不能使用 <code>window</code> 对象的默认方法和属性。然而你可以使用大量 <code>window</code> 对象之下的东西，包括 WebSockets，IndexDB 以及 FIreFox OS 专用的 Data Store API 等数据存储机制。</p><p>Workers 和主线程间的数据传递通过这样的消息机制进行，双方都使用 <code>postMessage()</code> 方法发送各自的消息，使用 <code>onmessage</code> 事件处理函数来响应消息（消息被包含在 <code>Message</code> 事件的 <code>data</code> 属性中）。这个过程中数据并不是被共享而是被复制。</p><p>Web Worker 有以下几个使用注意点：</p><ul><li>同源限制：分配给 Web Worker 线程运行的脚本文件，必须与主线程的脚本文件同源</li><li>DOM 限制：Worker 线程所在的全局对象，与主线程不一样，无法读取主线程所在网页的 DOM 对象，也无法使用 document、window、parent 这些对象。但是，Worker 线程可以访问 navigator 对象和 location 对象。</li><li>通信联系：Worker 线程和主线程不再同一个上下文环境，它们不能直接通信，必须通过消息完成。</li><li>脚本限制：Worker 线程不能执行 <code>alert()</code> 和 <code>confirm()</code> 方法，但可以使用 XMLHttpRequest 对象发出 AJAX 请求</li><li>文件限制：Worker 线程无法读取本地文件，即不能打开本地的文件系统（<code>file://</code>） ，它所加载的脚本，必须来自网络</li></ul><h2 id="基本用法"><a aria-hidden="true" href="#基本用法"><span class="icon icon-link"></span></a>基本用法</h2><h3 id="主线程"><a aria-hidden="true" href="#主线程"><span class="icon icon-link"></span></a>主线程</h3><p>主线程调用构造函数 Worker 创建一个 Worker 线程，构造函数参数是一个 URL。创建方式分为脚本文件和字符串形式。</p><p><strong>脚本文件形式</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const worker = new Worker(&#x27;https:// ~.js&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&#x27;https:// ~.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Worker 限制</p><ul><li><p>分配给 Worker 线程运行的脚本文件，必须与主线程的脚本文件同源。</p></li><li><p>Worker 不能读取本地的文件（不能打开本机的文件系统 <code>file://</code>），它所加载的脚本必须来自网络。</p></li></ul><p><strong>字符串形式</strong></p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const data = `
    // worker 线程 do something
`;
// 转成二进制对象
const blob = new Blob([data]);
// 生成URL
const url = window.URL.createObjectURL(blob);
// 加载URL
const worker = new Worker(url);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> </span><span class="token template-string template-punctuation string">`</span><span class="token template-string string"></span></div><div class="token-line"><span class="token template-string string">    // worker 线程 do something</span></div><div class="token-line"><span class="token template-string string"></span><span class="token template-string template-punctuation string">`</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 转成二进制对象</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> blob </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token plain">data</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 生成URL</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token method function property-access">createObjectURL</span><span class="token punctuation">(</span><span class="token plain">blob</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 加载URL</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Worker 构造函数的参数是一个脚本文件，该文件就是 Worker 线程所要执行的任务。由于 Worker 不能读取本地文件，所以这个脚本必须来自网络，如果下载没有成功（比如 404 错误），Worker 就会默默地失败。</p><p>然后，<strong>主线程</strong>调用 <code>worker.postMessage()</code> 方法，向 Worker 发消息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="worker.postMessage(&#x27;Hello world!&#x27;);
worker.postMessage({ method: &#x27;echo&#x27;, args: [&#x27;Work&#x27;] });
" data-status="copy"></button><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Hello world!&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token plain"> method</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;echo&#x27;</span><span class="token punctuation">,</span><span class="token plain"> args</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token string">&#x27;Work&#x27;</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>worker.postMessage()</code> 方法的参数，就是<strong>主线程</strong>传给 Worker 的数据。它可以是各种数据类型，包括二进制数据。</p><p>接着，<strong>主线程</strong>通过 <code>worker.onmessage()</code> 指定监听函数，接收 Worker 线程发回来的消息。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="worker.onmessage = function(event) {
  console.log(&#x27;Received message &#x27; + event.data);
  doSomthing();
};

function doSomething() {
  // 执行任务
  worker.postMessage(&#x27;Work done!&#x27;);
}
" data-status="copy"></button><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token string">&#x27;Received message &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">doSomthing</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// 执行任务</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Work done!&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，事件对象的 <code>data</code> 属性可以获取 Worker 发来的数据。</p><p>Worker 完成任务以后，主线程就可以把它关掉了。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="worker.terminate();
" data-status="copy"></button><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="worker-线程"><a aria-hidden="true" href="#worker-线程"><span class="icon icon-link"></span></a>Worker 线程</h2><p>Worker 线程内部需要有一个监听函数，监听 <code>message</code> 事件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="self.addEventListener(
  &#x27;message&#x27;,
  function(e) {
    self.postMessage(&#x27;You said: &#x27; + e.data);
  },
  false
);
" data-status="copy"></button><div class="token-line"><span class="token plain">self</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    self</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;You said: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码，<code>self</code> 代表 Worker 线程本身，即 Worker 线程的全局对象。因此，等同于以下两种写法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 写法一
this.addEventListener(
  &#x27;message&#x27;,
  function(e) {
    this.postMessage(&#x27;You said: &#x27; + e.data);
  },
  false
);

// 写法二
addEventListener(
  &#x27;message&#x27;,
  function(e) {
    postMessage(&#x27;You said: &#x27; + e.data);
  }.false
);
" data-status="copy"></button><div class="token-line"><span class="token comment">// 写法一</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;You said: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 写法二</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;You said: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>除了使用 <code>self.addEventListener()</code> 指定监听函数，也可以使用 <code>self.onmessage</code> 指定。监听函数的参数是一个事件对象，它的 <code>data</code> 属性包含主线程发来的数据。<code>self.postMessage()</code> 方法用来向主线程发送消息。</p><p>根据主线程发来的数据，Worker 线程可以调用不同的方法，下面是一个例子：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="self.addEventListener(
  &#x27;message&#x27;,
  function(e) {
    var data = e.data;
    switch (data.cmd) {
      case &#x27;start&#x27;:
        self.postMessage(&#x27;WORKER STARTED: &#x27; + data.msg);
        break;
      case &#x27;stop&#x27;:
        self.postMessage(&#x27;WORKER STOPPED: &#x27; + data.msg);
        self.close(); // Terminates the worker.
        break;
      default:
        self.postMessage(&#x27;Unknown command: &#x27; + data.msg);
    }
  },
  false
);
" data-status="copy"></button><div class="token-line"><span class="token plain">self</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">switch</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">.</span><span class="token property-access">cmd</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;start&#x27;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;WORKER STARTED: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> data</span><span class="token punctuation">.</span><span class="token property-access">msg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">case</span><span class="token plain"> </span><span class="token string">&#x27;stop&#x27;</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;WORKER STOPPED: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> data</span><span class="token punctuation">.</span><span class="token property-access">msg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// Terminates the worker.</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        </span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword module">default</span><span class="token punctuation">:</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Unknown command: &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> data</span><span class="token punctuation">.</span><span class="token property-access">msg</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，<code>self.close()</code> 用于在 Worker 内部关闭自身。</p><h3 id="终止"><a aria-hidden="true" href="#终止"><span class="icon icon-link"></span></a>终止</h3><p>如果需要从主线程中立刻终止一个运行中的 Worker，可以调用 Worker 的 <code>terminate</code> 方法。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="worker.terminate();
" data-status="copy"></button><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">terminate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Worker 线程会被立即杀死，不会有任何机会让它完成自己的操作或清理工作。</p><p>而在 Worker 线程中，Workers 也可以调用自己的 <code>close</code> 方法进行关闭。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="close();
" data-status="copy"></button><div class="token-line"><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="加载脚本"><a aria-hidden="true" href="#加载脚本"><span class="icon icon-link"></span></a>加载脚本</h3><p>Worker 内部如果要加载其它脚本，有一个专门的方法 <code>importScripts()</code>。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="importScripts(&#x27;script1.js&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">&#x27;script1.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>该方法可以同时加载多个脚本。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="importScripts(&#x27;script1.js&#x27;, &#x27;script2.js&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token function">importScripts</span><span class="token punctuation">(</span><span class="token string">&#x27;script1.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;script2.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h3 id="错误处理"><a aria-hidden="true" href="#错误处理"><span class="icon icon-link"></span></a>错误处理</h3><p>主线程可以监听 Worker 是否发生错误。如果发生错误，Worker 会触发主线程的 <code>error</code> 事件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="worker.onerror(function(event) {
  console.log([&#x27;ERROR: Line &#x27;, e.lineno, &#x27; in &#x27;, e.filename, &#x27;: &#x27;, e.message].join(&#x27;&#x27;));
});

// 或者
worker.addEventListener(&#x27;error&#x27;, function(event) {
  // ...
});
" data-status="copy"></button><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">onerror</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token console class-name">console</span><span class="token punctuation">.</span><span class="token method function property-access">log</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;ERROR: Line &#x27;</span><span class="token punctuation">,</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">lineno</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27; in &#x27;</span><span class="token punctuation">,</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">filename</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token string">&#x27;: &#x27;</span><span class="token punctuation">,</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">message</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token method function property-access">join</span><span class="token punctuation">(</span><span class="token string">&#x27;&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 或者</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="数据通信"><a aria-hidden="true" href="#数据通信"><span class="icon icon-link"></span></a>数据通信</h2><p>前面提及，主线程与 Worker 线程之间的通信内容，可以是文本，也可以是对象。需要注意的是，这种通信是拷贝关系，即是传值而不是传址，Worker 对通信内容的修改，不会影响到主线程。事实上，浏览器内部的运行机制是，现将通信内容串行化，然后把串行化的字符串发给 Worker，后者再将它还原。</p><p>主线程与 Worker 线程之间也可以交换二进制数据，比如 File、Blob、ArrayBuffer 等类型，也可以在线程之间发送。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 主线程
var uInt8Array = new Uint8Array(new ArrayBuffer(10));
for (var i = 0; i &lt; uInt8Array.length; ++i) {
  uInt8Array[i] = i * 2; // [0, 2, 4, 6, 8,...]
}
worker.postMessage(uInt8Array);

// Worker 线程
self.onmessage = function(e) {
  var uInt8Array = e.data;
  postMessage(&#x27;Inside worker.js: uInt8Array.toString() = &#x27; + uInt8Array.toString());
  postMessage(&#x27;Inside worker.js: uInt8Array.byteLength = &#x27; + uInt8Array.byteLength);
};
" data-status="copy"></button><div class="token-line"><span class="token comment">// 主线程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> uInt8Array </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Uint8Array</span><span class="token punctuation">(</span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> uInt8Array</span><span class="token punctuation">.</span><span class="token property-access">length</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token operator">++</span><span class="token plain">i</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  uInt8Array</span><span class="token punctuation">[</span><span class="token plain">i</span><span class="token punctuation">]</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> i </span><span class="token operator">*</span><span class="token plain"> </span><span class="token number">2</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// [0, 2, 4, 6, 8,...]</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">uInt8Array</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Worker 线程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">self</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> uInt8Array </span><span class="token operator">=</span><span class="token plain"> e</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Inside worker.js: uInt8Array.toString() = &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> uInt8Array</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;Inside worker.js: uInt8Array.byteLength = &#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> uInt8Array</span><span class="token punctuation">.</span><span class="token property-access">byteLength</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>但是，拷贝方式发送二进制数据，会造成性能问题。比如，主线程向 Worker 发送一个 500MB 文件，默认情况下浏览器会生成一个原文件的拷贝。为了解决这个问题，JavaScript 允许主线程把二进制数据直接转移给 Worker 线程，但是一旦转移，主线程就无法再使用这些二进制数据了，这是为了防止出现多个线程同时修改数据的麻烦局面。这种转移数据的方法，叫做 Transferable Objects。这使得主线程可以快速把数据交给 Worker，对于影像处理、声音处理、3D 运算等就非常方便了，不会产生性能负担。</p><p>如果要直接转移数据的控制权，就要使用下面的写法：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// Transferable Objects 格式
worker.postMessage(arrayBuffer, [arrayBuffer]);

// 例子
var ab = new ArrayBuffer(1);
worker.postMessage(ab, [ab]);
" data-status="copy"></button><div class="token-line"><span class="token comment">// Transferable Objects 格式</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">arrayBuffer</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">arrayBuffer</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// 例子</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> ab </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">ArrayBuffer</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">ab</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">[</span><span class="token plain">ab</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="同页面的-web-worker"><a aria-hidden="true" href="#同页面的-web-worker"><span class="icon icon-link"></span></a>同页面的 Web Worker</h2><p>通常情况下，Worker 载入的是一个单独的 JavaScript 脚本文件，但是也可以载入与主线程在同一个网页的代码。</p><div class="__dumi-default-code-block"><pre class="prism-code language-html"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="
  &lt;body&gt;
    &lt;script id=&quot;worker&quot; type=&quot;app/worker&quot;&gt;
      addEventListener(&#x27;message&#x27;, function () {
        postMessage(&#x27;some message&#x27;);
      }, false);
    &lt;/script&gt;
  &lt;/body&gt;
&lt;/html&gt;
" data-status="copy"></button><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;</span><span class="token tag">body</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token tag punctuation">&lt;</span><span class="token tag">script</span><span class="token tag"> </span><span class="token tag attr-name">id</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">worker</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag"> </span><span class="token tag attr-name">type</span><span class="token tag attr-value punctuation">=</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag attr-value">app/worker</span><span class="token tag attr-value punctuation">&quot;</span><span class="token tag punctuation">&gt;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">      </span><span class="token script language-javascript function">addEventListener</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;message&#x27;</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript keyword">function</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript"> </span><span class="token script language-javascript punctuation">{</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">        </span><span class="token script language-javascript function">postMessage</span><span class="token script language-javascript punctuation">(</span><span class="token script language-javascript string">&#x27;some message&#x27;</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">      </span><span class="token script language-javascript punctuation">}</span><span class="token script language-javascript punctuation">,</span><span class="token script language-javascript"> </span><span class="token script language-javascript boolean">false</span><span class="token script language-javascript punctuation">)</span><span class="token script language-javascript punctuation">;</span><span class="token script language-javascript"></span></div><div class="token-line"><span class="token script language-javascript">    </span><span class="token tag punctuation">&lt;/</span><span class="token tag">script</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token tag punctuation">&lt;/</span><span class="token tag">body</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token tag punctuation">&lt;/</span><span class="token tag">html</span><span class="token tag punctuation">&gt;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面是一段嵌入网页的脚本，注意必须指定 <code>&lt;script&gt;</code> 标签的 type 属性是一个浏览器不认识的值，上例是 <code>app/worker</code>。</p><p>然后，读取这一段嵌入页面的脚本，用 Worker 来处理。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var blob = new Blob([document.querySelector(&#x27;#worker&#x27;).textContent]);
var url = window.URL.createObjectURL(blob);
var worker = new Worker(url);

worker.onmessage = function(e) {
  // e.data === &#x27;some message&#x27;
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> blob </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">querySelector</span><span class="token punctuation">(</span><span class="token string">&#x27;#worker&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">textContent</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token method function property-access">createObjectURL</span><span class="token punctuation">(</span><span class="token plain">blob</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// e.data === &#x27;some message&#x27;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，先将嵌入网页的脚本代码，转成一个二进制对象，然后为这个二进制对象生成 URL，再让 Worker 加载这个 URL。这样就做到了，主线程和 Worker 的代码都在同一个网页上面。</p><h2 id="应用场景"><a aria-hidden="true" href="#应用场景"><span class="icon icon-link"></span></a>应用场景</h2><p>WebWorker 带来后台计算能力，WebWorker 自身是由 Webkit 多线程实现，但它并没有为 JavaScript 语言带来多线程编程特性，我们现在仍然不能在 JavaScript 代码中创建并管理一个线程，或者主动控制线程间的同步与锁等特性。Web Worker 只是浏览器（宿主环境）提供的一个能力 / API。而且它不支持 IE。</p><p><strong>使用专用线程进行数学运算</strong>Web Worker 最简单的应用就是用来做后台计算，而这种计算并不会中断前台用户的操作</p><p><strong>图像处理</strong>通过使用从 Canvas 或者 Video 元素中获取的数据，可以把图像分割成几个不同的区域并且把它们推送给并行的不同 Workers 来做计算</p><p><strong>大量数据的检索</strong>当需要在调用 AJAX 后处理大量的数据，如果处理这些数据所需的时间长短非常重要，可以在 Web Worker 中来做这些，避免冻结 UI 线程。</p><p><strong>背景数据分析</strong>由于在使用 Web Worker 的时候，我们有更多潜在的 CPU 可用时间，我们现在可以考虑一下 JavaScript 中的新应用场景。我们现在可以考虑一下 JavaScript 中的新应用场景。例如，我们可以想像在不影响 UI 体验的情况下实时处理用户输入。利用这样一种可能，我们可以想像一个像 Word（Office Web Apps 套装）一样的应用：当用户打字时后台在词典中进行查找，帮助用户自动纠错等等。</p><h2 id="实例：worker-线程完成轮询"><a aria-hidden="true" href="#实例：worker-线程完成轮询"><span class="icon icon-link"></span></a>实例：Worker 线程完成轮询</h2><p>有时，浏览器需要轮询服务器状态，以便第一时间得知状态改变。这个工作可以放在 Worker 线程里面完成。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="function createWorker(f) {
  var blob = new Blob([&#x27;(&#x27; + f.toString() +&#x27;)()&#x27;]);
  var url = window.URL.createObjectURL(blob);
  var worker = new Worker(url);
  return worker;
}

var pollingWorker = createWorker(function (e) {
  var cache;

  function compare(new, old) { ... };

  setInterval(function () {
    fetch(&#x27;/my-api-endpoint&#x27;).then(function (res) {
      var data = res.json();

      if (!compare(data, cache)) {
        cache = data;
        self.postMessage(data);
      }
    })
  }, 1000)
});

pollingWorker.onmessage = function () {
  // render data
}

pollingWorker.postMessage(&#x27;init&#x27;);
" data-status="copy"></button><div class="token-line"><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token parameter">f</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> blob </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#x27;(&#x27;</span><span class="token plain"> </span><span class="token operator">+</span><span class="token plain"> f</span><span class="token punctuation">.</span><span class="token method function property-access">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">+</span><span class="token string">&#x27;)()&#x27;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> url </span><span class="token operator">=</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token method function property-access">createObjectURL</span><span class="token punctuation">(</span><span class="token plain">blob</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">return</span><span class="token plain"> worker</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> pollingWorker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token function">createWorker</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> cache</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token parameter keyword">new</span><span class="token parameter punctuation">,</span><span class="token parameter"> old</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> </span><span class="token spread operator">...</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token string">&#x27;/my-api-endpoint&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token method function property-access">then</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token parameter">res</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">var</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> res</span><span class="token punctuation">.</span><span class="token method function property-access">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">compare</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">,</span><span class="token plain"> cache</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        cache </span><span class="token operator">=</span><span class="token plain"> data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">        self</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">data</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">pollingWorker</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token comment">// render data</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">pollingWorker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token string">&#x27;init&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，Worker 线程每秒钟轮询一次数据，然后跟缓存做比较。如果不一致，就说明服务端有了新的变化，因此就要通知主线程。</p><h2 id="实例：worker-新建-worker"><a aria-hidden="true" href="#实例：worker-新建-worker"><span class="icon icon-link"></span></a>实例：Worker 新建 Worker</h2><p>Worker 线程内部还能再新建 Worker 线程（目前只有 Firefox 浏览器支持）。下面的例子是将一个计算密集的任务，分配到 10 个 Worker。</p><p>主线程代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="var worker = new Worker(&#x27;worker.js&#x27;);
worker.onmessage = function(event) {
  document.getElementById(&#x27;result&#x27;).textContent = event.data;
};
" data-status="copy"></button><div class="token-line"><span class="token keyword">var</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&#x27;worker.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">worker</span><span class="token punctuation">.</span><span class="token method-variable function-variable method function property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token dom variable">document</span><span class="token punctuation">.</span><span class="token method function property-access">getElementById</span><span class="token punctuation">(</span><span class="token string">&#x27;result&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token property-access">textContent</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><strong>Worker 线程</strong>代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// worker.js

// settings
var num_workers = 10;
var items_per_worker = 1000000;

// start the workers
var result = 0;
var pending_workers = num_workers;
for (var i = 0; i &lt; num_workers; i += 1) {
  var worker = new Worker(&#x27;core.js&#x27;);
  worker.postMessage(i * items_per_worker);
  worker.postMessage((i + 1) * items_per_worker);
  worker.onmessage = storeResult;
}

// handle the results
function storeResult(event) {
  result += event.data;
  pending_workers -= 1;
  if (pending_workers &lt;= 0) postMessage(result); // finished!
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// worker.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// settings</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> num_workers </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">10</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> items_per_worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">1000000</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// start the workers</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> pending_workers </span><span class="token operator">=</span><span class="token plain"> num_workers</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> num_workers</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&#x27;core.js&#x27;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">*</span><span class="token plain"> items_per_worker</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token method function property-access">postMessage</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token plain">i </span><span class="token operator">+</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token operator">*</span><span class="token plain"> items_per_worker</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  worker</span><span class="token punctuation">.</span><span class="token property-access">onmessage</span><span class="token plain"> </span><span class="token operator">=</span><span class="token plain"> storeResult</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// handle the results</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">storeResult</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  result </span><span class="token operator">+=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  pending_workers </span><span class="token operator">-=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token plain">pending_workers </span><span class="token operator">&lt;=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// finished!</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，Worker 线程内部新建了 10 个 Worker 线程，并且依次向这 10 个 Worker 发送消息，告知了计算的起点和终点。计算任务脚本的代码如下：</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// core.js
var start;
onmessage = getStart;
function getStart(event) {
  start = event.data;
  onmessage = getEnd;
}

var end;
function getEnd(event) {
  end = event.data;
  onmessage = null;
  work();
}

function work() {
  var result = 0;
  for (var i = start; i &lt; end; i += 1) {
    // perform some complex calculation here
    result += 1;
  }
  postMessage(result);
  close();
}
" data-status="copy"></button><div class="token-line"><span class="token comment">// core.js</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> start</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">onmessage </span><span class="token operator">=</span><span class="token plain"> getStart</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  start </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  onmessage </span><span class="token operator">=</span><span class="token plain"> getEnd</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> end</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  end </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  onmessage </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword null nil">null</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">function</span><span class="token plain"> </span><span class="token function">work</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">var</span><span class="token plain"> result </span><span class="token operator">=</span><span class="token plain"> </span><span class="token number">0</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">for</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token keyword">var</span><span class="token plain"> i </span><span class="token operator">=</span><span class="token plain"> start</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">&lt;</span><span class="token plain"> end</span><span class="token punctuation">;</span><span class="token plain"> i </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// perform some complex calculation here</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    result </span><span class="token operator">+=</span><span class="token plain"> </span><span class="token number">1</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">postMessage</span><span class="token punctuation">(</span><span class="token plain">result</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="api"><a aria-hidden="true" href="#api"><span class="icon icon-link"></span></a>API</h2><h3 id="主线程-1"><a aria-hidden="true" href="#主线程-1"><span class="icon icon-link"></span></a>主线程</h3><p>浏览器原生提供 <code>Worker()</code> 构造函数，用来供主线程生成 Worker 线程。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="const worker = new Worker(url, options);
" data-status="copy"></button><div class="token-line"><span class="token keyword">const</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">,</span><span class="token plain"> options</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>Worker()</code> 构造函数，可以接受两个参数。第一个参数是脚本的网址（必须遵循同源策略），该参数是必须的，且只能区分多个 Worker 线程。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="// 主线程
var worker = new Worker(&#x27;worker.js&#x27;, { name: &#x27;worker&#x27; });

// Worker 线程
self.name; // worker
" data-status="copy"></button><div class="token-line"><span class="token comment">// 主线程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token keyword">var</span><span class="token plain"> worker </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">Worker</span><span class="token punctuation">(</span><span class="token string">&#x27;worker.js&#x27;</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> name</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token string">&#x27;worker&#x27;</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token comment">// Worker 线程</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">self</span><span class="token punctuation">.</span><span class="token property-access">name</span><span class="token punctuation">;</span><span class="token plain"> </span><span class="token comment">// worker</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>Worker()构造函数返回一个 Worker 线程对象，用来供主线程操作 Worker。Worker 线程对象的属性和方法如下：</p><ul><li>Worker.onerror：指定 error 事件的监听函数。</li><li>Worker.onmessage：指定 message 事件的监听函数，发送过来的数据在 Event.data 属性中。</li><li>Worker.onmessageerror：指定 messageerror 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li><li>Worker.postMessage()：向 Worker 线程发送消息。</li><li>Worker.terminate()：立即终止 Worker 线程。</li></ul><h3 id="worker-线程-1"><a aria-hidden="true" href="#worker-线程-1"><span class="icon icon-link"></span></a>Worker 线程</h3><p>Web Worker 有自己的全局对象，不是主线程的 <code>window</code>，而是一个专门为 Worker 定制的全局对象。因此定义在 <code>window</code> 上面的对象和方法不是全部都可以使用.</p><p>orker 线程有一些自己的全局属性和方法：</p><ul><li><code>self.name</code>： Worker 的名字。该属性只读，由构造函数指定。</li><li><code>self.onmessage</code>：指定 message 事件的监听函数。</li><li><code>self.onmessageerror</code>：指定 messageerror 事件的监听函数。发送的数据无法序列化成字符串时，会触发这个事件。</li><li><code>self.close()</code>：关闭 Worker 线程。</li><li><code>self.postMessage()</code>：向产生这个 Worker 线程发送消息。</li><li><code>self.importScripts()</code>：加载 JS 脚本。</li></ul><hr/><p><strong>参考资料：</strong></p><ul><li><a href="https://segmentfault.com/a/1190000009313491" target="_blank" rel="noopener noreferrer">聊聊 WebWorker<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://juejin.im/post/5b4af72ae51d45198d4b1388" target="_blank" rel="noopener noreferrer">Web Worker 初探<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook/edit/master/docs/browser-object-model/offline-and-storage/web-workers.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/18/2020, 12:00:58 PM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/javascript-guidebook/umi.js"></script>
    <script src="/javascript-guidebook/docs__browser-object-model__offline-and-storage__web-workers.md.js"></script>
  </body>
</html>
