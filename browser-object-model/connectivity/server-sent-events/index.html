<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no"
    />
    <link rel="shortcut icon" type="image/x-icon" href="./favicon.ico" />
    <link rel="stylesheet" href="/javascript-guidebook/umi.css" />
    <script>
      window.routerBase = "/javascript-guidebook/";
    </script>
    <script>
      //! umi version: 3.2.20
    </script>
    <title>Server-sent Events</title>
  
</head>
  <body>
    <div id="root"><div class="__dumi-default-layout" data-show-sidemenu="true" data-show-slugs="true" data-site-mode="true" data-gapless="false"><div class="__dumi-default-navbar" data-mode="site"><button class="__dumi-default-navbar-toggle"></button><a class="__dumi-default-navbar-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//">JavaScript Guidebook</a><nav><div class="__dumi-default-search"><input type="search" class="__dumi-default-search-input" value=""/><ul></ul></div><a href="/javascript-guidebook//basic-concept">基本语法</a><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a><a href="/javascript-guidebook//core-modules">核心模块</a><a href="/javascript-guidebook//object-oriented-programming">OOP</a><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model">BOM</a><a href="/javascript-guidebook//document-object-model">DOM</a><a href="/javascript-guidebook//computer-networks">计算机网络</a><a href="/javascript-guidebook//design-patterns">设计模式</a><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div><div class="__dumi-default-menu" data-mode="site"><div class="__dumi-default-menu-inner"><div class="__dumi-default-menu-header"><a class="__dumi-default-menu-logo" style="background-image:url(&#x27;http://img.mrsingsing.com/javascript-guidebook-favicon.png&#x27;)" href="/javascript-guidebook//"></a><h1>JavaScript Guidebook</h1><p>JavaScript 完全知识体系</p></div><div class="__dumi-default-menu-mobile-area"><ul class="__dumi-default-menu-nav-list"><li><a href="/javascript-guidebook//basic-concept">基本语法</a></li><li><a href="/javascript-guidebook//standard-built-in-objects">内置对象</a></li><li><a href="/javascript-guidebook//core-modules">核心模块</a></li><li><a href="/javascript-guidebook//object-oriented-programming">OOP</a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model">BOM</a></li><li><a href="/javascript-guidebook//document-object-model">DOM</a></li><li><a href="/javascript-guidebook//computer-networks">计算机网络</a></li><li><a href="/javascript-guidebook//design-patterns">设计模式</a></li><li><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook">Github<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><ul class="__dumi-default-menu-list"><li><a href="/javascript-guidebook//browser-object-model">BOM 浏览器对象模型</a></li><li><a href="/javascript-guidebook//browser-object-model/window">全局对象</a><ul><li><a href="/javascript-guidebook//browser-object-model/window/window"><span>Window 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/location"><span>Location 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/history"><span>History 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/screen"><span>Screen 对象</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window/navigator"><span>Navigator 对象</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/web-event">全局 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/web-event/set-interval"><span>setInterval 间歇调用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/set-time-out"><span>setTimeout 超时调用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/alert"><span>alert</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/confirm"><span>confirm</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/prompt"><span>prompt</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/drag-and-drop-api"><span>拖放 API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/web-event/request-animation-frame"><span>动画 API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/window-position">视窗尺寸位置</a><ul><li><a href="/javascript-guidebook//browser-object-model/window-position/window-view-properties"><span>Window 对象视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/screen-view-properties"><span>Screen 对象视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/element-view-properties"><span>Element 文档元素视图属性</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/document-view-and-element-view"><span>文档视图和元素视图</span></a></li><li><a href="/javascript-guidebook//browser-object-model/window-position/mouse-position"><span>鼠标位置</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files">二进制数据和文件 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/local-files-application"><span>本地文件应用</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/blob"><span>Blob API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file"><span>File API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-list"><span>FileList API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-reader"><span>FileReader API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/file-reader-sync"><span>FileReaderSync API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/url"><span>URL API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/binary-data-and-files/form-data"><span>FormData API</span></a></li></ul></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model/connectivity">数据通信 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/connectivity/post-message"><span>PostMessage</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/xmlhttprequest"><span>XHMLHttpRequest API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/featch"><span>Fetch API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/beacon"><span>Beacon API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/web-socket"><span>WebSocket</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/event-source"><span>EventSource</span></a></li><li><a aria-current="page" class="active" href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events"><span>Server-sent Events</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/web-real-time-communication"><span>WebRTC</span></a></li><li><a href="/javascript-guidebook//browser-object-model/connectivity/progress-event"><span>Progress Event</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage">离线与存储 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/browser-cache"><span>浏览器缓存机制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/http-cache"><span>HTTP Cache</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/cookie"><span>Cookie</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-storage"><span>Web Storage</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/web-workers"><span>Web Workers</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/service-worker"><span>Service Worker</span></a></li><li><a href="/javascript-guidebook//browser-object-model/offline-and-storage/indexed-db"><span>IndexedDB</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/performance">性能 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/performance/performance"><span>Performance API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/performance-resource-timing"><span>Performance Resource Timing API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/performance-navigation-timing"><span>Performance Navifation API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/performance/perfromance-timeline"><span>性能时间线</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/multimedia">多媒体 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/multimedia/audio"><span>音频 Web Audio API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/multimedia/video"><span>视频 Web Video API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/device">设备 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/device/geolocation"><span>地理定位 Geolocation API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/device/camera"><span>摄录设备</span></a></li><li><a href="/javascript-guidebook//browser-object-model/device/position"><span>位置信息 Position API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/integration">集成 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/integration/full-screen"><span>全屏 Fullscreen API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/observer">监视 API</a><ul><li><a href="/javascript-guidebook//browser-object-model/observer/intersection-observer"><span>IntersectionObserver API</span></a></li><li><a href="/javascript-guidebook//browser-object-model/observer/mutation-observer"><span>MutationObserver API</span></a></li></ul></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle">浏览器工作原理</a><ul><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/browser-architecture"><span>浏览器架构</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/workflow"><span>渲染进程的内部机制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/construction-of-the-object-model"><span>构建对象模型</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/script-loading-asynchronously"><span>脚本异步加载</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/construction-of-render-tree"><span>渲染树构建</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/layout"><span>布局</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/paint"><span>绘制</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/composite"><span>合并</span></a></li><li><a href="/javascript-guidebook//browser-object-model/browser-working-principle/browser-event"><span>浏览器事件处理</span></a></li></ul></li></ul></div></div><ul class="__dumi-default-layout-toc" role="slug-list"><li title="本质" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#本质"><span>本质</span></a></li><li title="特点" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#特点"><span>特点</span></a></li><li title="客户端实现" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#客户端实现"><span>客户端实现</span></a></li><li title="服务器实现" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#服务器实现"><span>服务器实现</span></a></li><li title="数据格式" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#数据格式"><span>数据格式</span></a></li><li title="data 字段" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#data-字段"><span>data 字段</span></a></li><li title="id 字段" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#id-字段"><span>id 字段</span></a></li><li title="event 字段" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#event-字段"><span>event 字段</span></a></li><li title="retry 字段" data-depth="2" class=""><a href="/javascript-guidebook//browser-object-model/connectivity/server-sent-events#retry-字段"><span>retry 字段</span></a></li></ul><div class="__dumi-default-layout-content"><div class="markdown"><h1 id="server-sent-events"><a aria-hidden="true" href="#server-sent-events"><span class="icon icon-link"></span></a>Server-sent Events</h1><p>服务器向浏览器推送消息，除了 WebSocket，还有一种方法：Sever-sent Events（以下简称 SSE）。</p><p>W3C 关于 Server-Sent Events 部分的描述 <a href="https://www.w3.org/TR/eventsource/" target="_blank" rel="noopener noreferrer">W3C Server-Sent Events<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p><p>相比以往的轮询，SSE 可以为 B2C 带来更高的效率。</p></div><img alt="Server-sent Events" src="/javascript-guidebook/static/sever-sent-worker.ad3a72c1.png" width="720"/><div class="markdown"><h2 id="本质"><a aria-hidden="true" href="#本质"><span class="icon icon-link"></span></a>本质</h2><p>严格来说，HTTP 协议无法让服务器向客户端主动推送消息。但是，有一种变通方法，就是服务器向客户端声明，接下来要发送的是流信息（Streaming）。</p><p>也就是说，发送的不是一次性的数据包，而是一个数据流，会连续不断地发送过来。这时，客户端不会关闭连接，会一直等着服务器发过来的新的数据流，视频播放就是这样的例子。本质上，这种通信就是以流信息的方式，完成一次用时很长的下载。</p><p>SSE 就是利用这种机制，使用流信息向浏览器推送信息。它基于 HTTP 协议，目前除了 IE/Edge，其他浏览器都支持。</p><h2 id="特点"><a aria-hidden="true" href="#特点"><span class="icon icon-link"></span></a>特点</h2><p>SSE 与 WebSocket 作用相似，都是建立浏览器与服务器之间的通信渠道，然后服务器向浏览器推送信息。</p><p>总体来说，WebSocket 更强大和灵活。因为它是全双工通道，可以双向通信；SSE 是<strong>单向通道</strong>，只能服务器向浏览器发送，因为流信息本质上就是下载。如果浏览器向服务器发送信息，就变成了另一次 HTTP 请求。</p><p>虽然如此，SSE 在设计时就拥有了一些 WebSocket 没有的特性，例如自动重连接、Event IDs 以及发送随机事件的能力等，我们需要根据实际应用场景，去选择不同的应用方案。</p><p><strong>SSE 优点：</strong></p><ul><li>SSE 基于 HTTP 协议，现有的服务器软件都支持。WebSocket 是一个独立协议。</li><li>SSE 属于轻量级，使用简单；WebSocket 协议相对复杂。</li><li>SSE 默认支持断线重连，WebSocket，需要自己实现。</li><li>SSE 一般只用来传送文本，二进制数据需要编码后传送，WebSocket，默认支持传送二进制数据。</li><li>SSE 支持自定义发送的消息类型。</li></ul><p><strong>SSE 和 WebSocket 对比</strong></p><table><thead><tr><th></th><th>是否基于新协议</th><th>是否双向通信</th><th>是否支持跨域</th><th>接入成本</th></tr></thead><tbody><tr><td>SSE</td><td>否（<code>HTTP</code>）</td><td>否（服务器单向）</td><td>否（Firefox 支持）</td><td>低</td></tr><tr><td>WebSocket</td><td>是（<code>WS</code>）</td><td>是</td><td>是</td><td>高</td></tr></tbody></table><h2 id="客户端实现"><a aria-hidden="true" href="#客户端实现"><span class="icon icon-link"></span></a>客户端实现</h2><p>EventSource 接口用于接收服务器发送的事件。它通过 HTTP 连接到一个服务器，以 <code>text/event-stream</code> 格式接收事件，不关闭连接。</p><ul><li>浏览器生成 EventSource 实例，向服务器发起连接。</li><li>建立 EventSource 实例时，构造函数接收当前网址网域作为第一参数，也可以跨域。跨域时，可以指定第二个参数，打开 <code>withCredentials</code> 属性，表示是否一起发送 Cookie。</li><li>EventSource 实例的 <code>readyState</code> 属性，表明连接的当前状态。该属性只读，只可以取以下值。<ul><li><code>0</code>：相当于常量 <code>EventSource.CONNECTING</code>，表示连接还未建立，或者断线正在重连。</li><li><code>1</code>：相当于常量 <code>EventSource.OPEN</code>，表示连接已经建立，可以接受数据。</li><li><code>2</code>：相当于常量 <code>EventSource.CLOSED</code>，表示连接已断，且不会重连。</li></ul></li><li>连接一旦建立，就会触发 <code>open</code> 事件，可以在 <code>onopen</code> 属性定义回调函数。（连接事件源）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="if (&#x27;EventSource&#x27; in window) {
  const source = new EventSource(url, { withCredentials: true });

  source.addEventListener(
    &#x27;open&#x27;,
    event =&gt; {
      // ...
    },
    false
  );
}
" data-status="copy"></button><div class="token-line"><span class="token keyword">if</span><span class="token plain"> </span><span class="token punctuation">(</span><span class="token string">&#x27;EventSource&#x27;</span><span class="token plain"> </span><span class="token keyword">in</span><span class="token plain"> </span><span class="token dom variable">window</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">const</span><span class="token plain"> source </span><span class="token operator">=</span><span class="token plain"> </span><span class="token keyword">new</span><span class="token plain"> </span><span class="token class-name">EventSource</span><span class="token punctuation">(</span><span class="token plain">url</span><span class="token punctuation">,</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"> withCredentials</span><span class="token punctuation">:</span><span class="token plain"> </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain">  source</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token string">&#x27;open&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token parameter">event</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">      </span><span class="token comment">// ...</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">}</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>客户端收到服务器发来的数据，就会触发 <code>message</code> 事件，可以在 <code>onmessage</code> 属性的回调函数。（接收事件）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="source.addEventListener(
  &#x27;message&#x27;,
  evnet =&gt; {
    const data = event.data;
    // handle message
  },
  false
);
" data-status="copy"></button><div class="token-line"><span class="token plain">source</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;message&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">evnet</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">const</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// handle message</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>上述代码中，事件对象 <code>data</code> 属性就是服务器端传回的数据（文本格式）。</li><li>如果发生通信错误（比如连接中断），就会触发 <code>error</code> 事件，可以在 <code>onerror</code> 属性定义回调函数。（错误处理）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="source.addEventListener(
  &#x27;error&#x27;,
  event =&gt; {
    // handle error event
  },
  false
);
" data-status="copy"></button><div class="token-line"><span class="token plain">source</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;error&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token parameter">event</span><span class="token plain"> </span><span class="token arrow operator">=&gt;</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// handle error event</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li><code>close()</code> 方法用于关闭 SSE 连接。（主动断开连接）</li></ul><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="source.close();
" data-status="copy"></button><div class="token-line"><span class="token plain">source</span><span class="token punctuation">.</span><span class="token method function property-access">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><strong>自定义事件</strong></p><p>默认情况下，服务器发来的数据，总是触发浏览器 <code>EventSource</code> 实例的 <code>message</code> 事件。开发者还可以自定义 SSE 事件，这种情况下，发送回来的数据不会触发 <code>message</code> 事件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-js"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="source.addEventListener(
  &#x27;foo&#x27;,
  function(event) {
    var data = event.data;
    // handle message
  },
  false
);
" data-status="copy"></button><div class="token-line"><span class="token plain">source</span><span class="token punctuation">.</span><span class="token method function property-access">addEventListener</span><span class="token punctuation">(</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token string">&#x27;foo&#x27;</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span><span class="token plain"> </span><span class="token punctuation">{</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token keyword">var</span><span class="token plain"> data </span><span class="token operator">=</span><span class="token plain"> event</span><span class="token punctuation">.</span><span class="token property-access">data</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">    </span><span class="token comment">// handle message</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token plain"></span></div><div class="token-line"><span class="token plain">  </span><span class="token boolean">false</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面代码中，浏览器对 SSE 的<code>foo</code>事件进行监听。如何实现服务器发送 <code>foo</code> 事件，请看下文。</p><h2 id="服务器实现"><a aria-hidden="true" href="#服务器实现"><span class="icon icon-link"></span></a>服务器实现</h2><h2 id="数据格式"><a aria-hidden="true" href="#数据格式"><span class="icon icon-link"></span></a>数据格式</h2><p>服务器高速客户端，返回的类型是事件流 <code>text/event-stream</code>。事件流仅仅是一个简单的文本数据流，文本应该使用 UTF-8 格式的编码。每条消息后面都由一个空行作为分隔符。以冒号开头的行为注释行，会被忽略。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="Content-Type: text/event-stream
Cache-Control: no-cache
Connection: keep-alive
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">Content-Type:</span><span class="token plain"> text/event-stream</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">Cache-Control:</span><span class="token plain"> no-cache</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">Connection:</span><span class="token plain"> keep-alive</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><ul><li>SSE 的 MIME Type 规定为 <code>text/event-stream</code></li><li>SSE 肯定不允许缓存</li><li>SSE 是一个一直打开的 TCP 连接，所以 Connection 为 Keep-alive</li></ul><p>每次发送的消息，由若干个 <code>message</code> 组成，每个 <code>message</code> 之间用 <code>\n\n</code> 分隔。每个 <code>message</code> 内部由若干行组成，每一行都是如下格式。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="[field]: value\n
" data-status="copy"></button><div class="token-line"><span class="token plain">[field]: value\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p><code>filed</code> 可能的类型包括：</p><ul><li>空：表示该行是注释，会在处理时被忽略。</li><li>data：表示该行包含的是数据。以 data 开头的行可以出现多次。所有这些行都是该事件的数据。</li><li>event：表示该行用来声明事件的类型。浏览器在收到数据时，会产生对应类型的事件。</li><li>id：表示该行用来声明事件的标识符。</li><li>retry：表示该行用来声明浏览器在连接断开之后进行再次连接之前的等待时间。</li></ul><p>此外，还可以有冒号开头的行，表示注释。通常，服务器每隔一段时间就会向浏览器发送一个注释，保持连接不中断。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text=": This is a comment
" data-status="copy"></button><div class="token-line"><span class="token plain">: This is a comment</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="data-字段"><a aria-hidden="true" href="#data-字段"><span class="icon icon-link"></span></a>data 字段</h2><p>数据内容由 <code>data</code> 字段表示。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="data: message\n\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">data:</span><span class="token plain"> message\n\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>如果数据很长，可以分成多行，最后一行以 <code>\n\n</code> 结尾，前面行都用 <code>\n</code> 结尾。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="data: begin message\n
data: continue message\n\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">data:</span><span class="token plain"> begin message\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> continue message\n\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>下面是一个发送 JSON 数据的例子。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="data: {\n
data: &quot;foo&quot;: &quot;bar&quot;,\n
data: &quot;baz&quot;: &#x27;123&#x27;,\n
data: }\n\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">data:</span><span class="token plain"> {\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> &quot;foo&quot;: &quot;bar&quot;,\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> &quot;baz&quot;: &#x27;123&#x27;,\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> }\n\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="id-字段"><a aria-hidden="true" href="#id-字段"><span class="icon icon-link"></span></a>id 字段</h2><p>数据标识符用 <code>id</code> 字段表示，相当于每一条数据的编号。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="id: msg1\n
data: message\n\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">id:</span><span class="token plain"> msg1\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> message\n\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>浏览器用 <code>lastEventId</code> 属性读取这个值。一旦连接断线，浏览器会发送一个 HTTP 头，里面包含一个特殊的 <code>Last-Event-ID</code> 头信息，将这个值发送回来，用来帮助服务器端重建连接。因此，这个头信息可以被视为一种同步机制。</p><h2 id="event-字段"><a aria-hidden="true" href="#event-字段"><span class="icon icon-link"></span></a>event 字段</h2><p><code>event</code> 字段表示自定义的事件类型，默认是 <code>message</code> 事件。浏览器可以用 <code>addEventListener()</code> 监听该事件。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="event: foo\n
data: a foo event\n\n

data: an unnamed event\n\n

event: bar\n
data: a bar event\n\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">event:</span><span class="token plain"> foo\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> a foo event\n\n</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> an unnamed event\n\n</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">event:</span><span class="token plain"> bar\n</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> a bar event\n\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>上面的代码创造了三条信息。第一条的名字是 <code>foo</code>，触发浏览器的 <code>foo</code> 事件；第二条未取名，表示默认类型，触发浏览器的 <code>message</code> 事件；第三条是 <code>bar</code>，触发浏览器的 <code>bar</code> 事件。</p><p>下面是另一个例子。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="event: userconnect
data: {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:33:48&quot;}

event: usermessage
data: {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:34:11&quot;, &quot;text&quot;: &quot;Hi everyone.&quot;}

event: userdisconnect
data: {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:34:23&quot;}

event: usermessage
data: {&quot;username&quot;: &quot;sean&quot;, &quot;time&quot;: &quot;02:34:36&quot;, &quot;text&quot;: &quot;Bye, bobby.&quot;}
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">event:</span><span class="token plain"> userconnect</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:33:48&quot;}</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">event:</span><span class="token plain"> usermessage</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:34:11&quot;, &quot;text&quot;: &quot;Hi everyone.&quot;}</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">event:</span><span class="token plain"> userdisconnect</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> {&quot;username&quot;: &quot;bobby&quot;, &quot;time&quot;: &quot;02:34:23&quot;}</span></div><div class="token-line"><span class="token plain"></span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">event:</span><span class="token plain"> usermessage</span></div><div class="token-line"><span class="token plain"></span><span class="token header-name keyword">data:</span><span class="token plain"> {&quot;username&quot;: &quot;sean&quot;, &quot;time&quot;: &quot;02:34:36&quot;, &quot;text&quot;: &quot;Bye, bobby.&quot;}</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><h2 id="retry-字段"><a aria-hidden="true" href="#retry-字段"><span class="icon icon-link"></span></a>retry 字段</h2><p>服务器可以用 <code>retry</code> 字段，指定浏览器重新发起连接的时间间隔。</p><div class="__dumi-default-code-block"><pre class="prism-code language-http"><button title="" type="button" class="__dumi-default-icon __dumi-default-btn-copy __dumi-default-code-block-copy-btn" data-clipboard-text="retry: 10000\n
" data-status="copy"></button><div class="token-line"><span class="token header-name keyword">retry:</span><span class="token plain"> 10000\n</span></div><div class="token-line"><span class="token plain"></span></div></pre></div><p>两种情况会导致浏览器重新发起连接：一种是时间间隔到期，二是由于网络错误等原因，导致连接出错。</p><hr/><p><strong>参考资料：</strong></p><ul><li><a href="http://www.ruanyifeng.com/blog/2017/05/server-sent_events.html" target="_blank" rel="noopener noreferrer">Server-sent Events 教程<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Server-sent_events/Using_server-sent_events" target="_blank" rel="noopener noreferrer">MDN:使用服务器发送事件<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://www.ibm.com/developerworks/cn/web/1307_chengfu_serversentevent/index.html" target="_blank" rel="noopener noreferrer">HTML5 服务器推送事件（Server-sent Events）实战开发<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li><li><a href="https://blog.5udou.cn/blog/JSShi-Shi-Tong-Xin-San-Ba-Fu-Xi-Lie-Zhi-San-eventsource55" target="_blank" rel="noopener noreferrer">JS 实时通信三把斧系列之三：EventSource<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div><div class="__dumi-default-layout-footer-meta"><a target="_blank" rel="noopener noreferrer" href="https://github.com/tsejx/javascript-guidebook/edit/master/docs/browser-object-model/connectivity/server-sent-events.md">Edit this doc on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="__dumi-default-external-link-icon"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a><span data-updated-text="Last Update: ">9/19/2020, 10:25:22 AM</span></div></div></div></div>
	<script>
  window.g_useSSR = true;
  window.g_initialProps = {};
	</script>

    <script src="/javascript-guidebook/umi.js"></script>
    <script src="/javascript-guidebook/docs__browser-object-model__connectivity__server-sent-events.md.js"></script>
  </body>
</html>
